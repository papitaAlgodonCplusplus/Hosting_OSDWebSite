<!-- Container to wrap everything, giving some spacing and a consistent layout -->
<div class="container mx-auto p-6 space-y-6 text-darkslategray animate__animated animate__fadeInLeft">

  <!-- Title Section -->
  <div class="flex flex-col items-start">
    <h2 class="text-xl font-medium py-3">
      <span class="pl-5 pr-3 py-1 bg-yellow-500 rounded-r-full">
        {{ 'reclamacion' | translate }}
      </span>
    </h2>
  </div>

  <!-- Performance Buttons -->
  <div class="flex justify-center py-3">
    <div class="flex flex-col items-center space-y-3 p-3">
      <!-- View Performance Button -->
      <span class="rounded-xl p-2 bg-darkslategray text-line font-bold cursor-pointer"
        (click)="openPerformanceClaimsModal()">
        {{ 'viewPerformance' | translate }}
      </span>
    </div>
  </div>

  <!-- Main Form Section -->
  <div class="bg-white-lightbone shadow-md rounded-xl p-5">
    <form [formGroup]="fileManager" (ngSubmit)="onSubmit()" autocomplete="off"
      class="grid grid-cols-1 lg:grid-cols-2 gap-4">

      <!-- Code Field -->
      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Code' | translate }}</label>
        <input formControlName="code" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.code" />
      </div>

      <div class="flex flex-col items-center space-y-1">
        <!-- Label for the button -->
        <label for="downloadButton" class="text-sm text-gray-700 font-medium">
          {{ 'Justification/Proof File of the Claim' | translate }}
        </label>

        <!-- Modified Button -->
        <button id="downloadButton" type="button" class="cursor-pointer px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg shadow-md 
          hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 
          transition ease-in-out duration-150" (click)="downloadSelectedFile('')">
          {{ 'Download' | translate }}
        </button>
      </div>

      <!-- Complaint Field -->
      <div class="col-span-1 lg:col-span-2 w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Complaint' | translate }}</label>
        <textarea formControlName="complaint" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.complaint || 'No complaint provided'"></textarea>
      </div>

      <!-- Appeal Field -->
      <div class="col-span-1 lg:col-span-2 w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Appeal' | translate }}</label>
        <textarea formControlName="appeal" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.appeal || 'No appeal provided'"></textarea>
      </div>

      <!-- Solution Suggestion Field -->
      <div class="col-span-1 lg:col-span-2 w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Solution Suggestion' | translate }}</label>
        <textarea formControlName="solutionSuggestion" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.solution_suggestion || 'No solution suggestion provided'"></textarea>
      </div>

      <!-- Facts Field -->
      <div class="col-span-1 lg:col-span-2 w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Facts' | translate }}</label>
        <textarea formControlName="facts" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.facts"></textarea>
      </div>

      <!-- Claimant Field -->
      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Reclamación' | translate }}</label>
        <input formControlName="claimant" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.namecompanysubscriberclaimed" />
      </div>

      <!-- Status Field -->
      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Status' | translate }}</label>
        <input formControlName="state" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.status" />
      </div>

      <!-- Subscriber Field -->
      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Subscriber' | translate }}</label>
        <input formControlName="subscriber" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.subscriberclaimedid" />
      </div>

      <!-- Amount Claimed Field -->
      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Amount Claimed' | translate }}</label>
        <input formControlName="amountClaimed" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.amountclaimed" />
      </div>
    </form>
  </div>

  <!-- Processor Form Section -->
  <div class="bg-white-lightbone shadow-md rounded-xl p-5 mt-6">
    <form [formGroup]="closeClaimfileForm" (ngSubmit)="closeClaimFileDirect()" autocomplete="off"
      class="grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="col-span-1 lg:col-span-2 border-b pb-3">
        <h1 class="font-bold">{{ 'Processor' | translate }}</h1>
      </div>

      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'amountPaidByOtherParty' | translate }}</label>
        <input formControlName="AmountPaid" type="text" class="w-full bg-white-lightbone"
          [readonly]="user.AccountType != 'FreeProfessional' || !isTerminatedPerformance"
          [placeholder]="this.claim?.amountpaid" />
      </div>

      <div class="w-full border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'institutionalImprovementSavings' | translate }}</label>
        <input formControlName="AAsavingsPP" type="text" class="w-full bg-white-lightbone"
          [readonly]="user.AccountType != 'FreeProfessional' || !isTerminatedPerformance"
          [placeholder]="this.claim?.improvementsavings" />
      </div>
    </form>
  </div>

  <!-- Button Section -->
  <div class="flex w-full justify-end p-2 space-x-3">
    <button routerLink="/functions/claims-file"
      class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
      {{ 'regresar' | translate }}
    </button>

    <!-- Instead of directly calling closeClaimFile(), open a "Finalize" modal to gather the rating -->
    <button (click)="openFinalizeModal()"
      class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
      {{ 'Finalizar expediente de reclamacion' | translate }}
    </button>
  </div>

  <!-- Add Update Modal -->
  <div *ngIf="showAddUpdateModal" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
      <div class="p-3 flex flex-col items-center">
        <h1 class="text-center text-darkslategray font-medium text-xl mb-3">
          Add Update
        </h1>

        <!-- Modal Form -->
        <form [formGroup]="addUpdateForm" class="w-full flex flex-col space-y-3" (ngSubmit)="submitAddUpdate()">

          <!-- Ask for More Info Checkbox -->
          <div class="flex items-center w-full" *ngIf="isUserProcessor">
            <input formControlName="askForMoreInfo" id="askForMoreInfo" type="checkbox" class="mr-2" />
            <label for="askForMoreInfo" class="font-semibold">Ask for more info</label>
          </div>

          <!-- Status Field -->
          <div *ngIf="isUserProcessor" class="flex flex-col w-full">
            <label for="performanceStatus" class="font-semibold mb-1">Status</label>
            <select formControlName="status" id="performanceStatus"
              class="border border-gray-300 rounded-md p-2 bg-white">
              <option value="" disabled>Select Status</option>
              <option value="Running">Running</option>
              <option value="Closed">Closed</option>
              <option value="Completed">Completed</option>
              <option value="Falta Información">Falta Información</option>
            </select>
          </div>

          <!-- Document Field -->
          <div *ngIf="!isSubscriber" class="flex flex-col w-full">
            <label for="performanceDocument" class="font-semibold mb-1">Document</label>
            <input formControlName="document" id="performanceDocument" class="border border-gray-300 rounded-md p-2"
              type="file" (change)="onFileUpload($event)" />
          </div>

          <!-- Summary / Reason Field -->
          <div *ngIf="!isSubscriber" class="flex flex-col w-full">
            <label for="performanceSummary" class="font-semibold mb-1">
              <!-- If askForMoreInfo is true, show "Reason / Missing Info", otherwise "Summary" -->
              {{ addUpdateForm.get('askForMoreInfo')?.value ? 'Reason / Missing Info' : 'Summary' }}
            </label>
            <textarea formControlName="summary" id="performanceSummary" class="border border-gray-300 rounded-md p-2"
              placeholder="{{ addUpdateForm.get('askForMoreInfo')?.value ? 'Enter the reason or missing information' : 'Enter a short description or summary' }}"></textarea>
          </div>

          <!-- Improvement/Savings Field -->
          <div *ngIf="isUserProcessor" class="flex flex-col w-full">
            <label for="improvementSavings" class="font-semibold mb-1">Improvement/Savings Inst/Entity</label>
            <input formControlName="improvementSavings" id="improvementSavings"
              class="border border-gray-300 rounded-md p-2" type="number"
              placeholder="Enter improvement/savings amount" />
          </div>

          <!-- Amount Paid Field -->
          <div *ngIf="isUserProcessor" class="flex flex-col w-full">
            <label for="amountPaid" class="font-semibold mb-1">Amount paid by other party</label>
            <input formControlName="amountPaid" id="amountPaid" class="border border-gray-300 rounded-md p-2"
              type="number" placeholder="Enter amount paid" />
          </div>

          <!-- Crediting Date Field -->
          <div *ngIf="isUserProcessor" class="flex flex-col w-full">
            <label for="creditingDate" class="font-semibold mb-1">Crediting Date</label>
            <input formControlName="creditingDate" id="creditingDate" class="border border-gray-300 rounded-md p-2"
              type="date" />
          </div>

          <!-- Facts Update Field (conditionally displayed) -->
          <div *ngIf="this.claim?.status === 'Falta Información' && !isUserProcessor" class="flex flex-col w-full">
            <label for="factsUpdate" class="font-semibold mb-1">Facts Update</label>
            <textarea formControlName="factsUpdate" id="factsUpdate" class="border border-gray-300 rounded-md p-2"
              placeholder="Provide updated facts"></textarea>
          </div>

          <!-- Complaint Field (conditionally displayed) -->
          <div *ngIf="isSubscriber" class="flex flex-col w-full">
            <label for="complaint" class="font-semibold mb-1">{{ 'complaint' | translate }}</label>
            <textarea formControlName="complaint" id="complaint" class="border border-gray-300 rounded-md p-2"
              placeholder="{{ 'Enter your complaint' | translate }}"></textarea>
          </div>

          <!-- Appeal Field (conditionally displayed) -->
          <div *ngIf="isSubscriber" class="flex flex-col w-full">
            <label for="appeal" class="font-semibold mb-1">{{ 'appeal' | translate }}</label>
            <textarea formControlName="appeal" id="appeal" class="border border-gray-300 rounded-md p-2"
              placeholder="{{ 'Enter your appeal' | translate }}"></textarea>
          </div>

          <!-- Solution Suggestion Field (conditionally displayed) -->
          <div *ngIf="isSubscriber" class="flex flex-col w-full">
            <label for="solutionSuggestion" class="font-semibold mb-1">{{ 'solution_suggestion' | translate }}</label>
            <textarea formControlName="solutionSuggestion" id="solutionSuggestion"
              class="border border-gray-300 rounded-md p-2"
              placeholder="{{ 'Enter your solution suggestion' | translate }}"></textarea>
          </div>

          <!-- Submit / Cancel Buttons -->
          <div class="flex justify-end space-x-3 mt-3">
            <button type="button" (click)="closeAddUpdateModal()"
              class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
              Cancel
            </button>
            <button type="submit"
              class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
              Submit
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Performance Modal -->
  <div *ngIf="showModalPerformances" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-3/4">
      <div class="p-3 flex flex-col items-center space-y-3">
        <table class="table-auto w-full">
          <thead>
            <tr class="text-darkslategray border-b">
              <th class="py-2">{{ 'Code' | translate }}</th>
              <th class="py-2">{{ 'Date' | translate }}</th>
              <th class="py-2">{{ 'Type' | translate }}</th>
              <th class="py-2">{{ 'status' | translate }}</th>
              <th class="py-2">{{ 'Summary' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr class="border-t text-center" *ngFor="let performance of displayedItems; let i = index">
              <td class="p-3">{{ performance.code }}</td>
              <td class="p-3">{{ performance.dateperformance | date:'dd-MM-yyyy' }}</td>
              <td class="p-3">{{ claim?.claimtype }}</td>
              <td class="p-3">{{ performance.status | translate }}</td>
              <td class="p-3">{{ performance.summary | translate }}</td>
            </tr>
          </tbody>
        </table>

        <mat-paginator [length]="allPerformances.length" [pageSize]="5" (page)="onPageChange($event)"></mat-paginator>

        <div class="flex justify-end w-full space-x-3">
          <button (click)="openAddUpdateModal()"
            class="p-2 rounded-xl bg-indigo-500 text-white font-medium animate__animated animate__fadeInDown">
            Add Update
          </button>
          <button (click)="closePerformanceModal()"
            class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
            {{ 'regresar' | translate }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Finalize Claim (Rating) Modal -->
  <div *ngIf="showFinalizeModal" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
      <div class="p-3 flex flex-col items-center">
        <h1 class="text-center text-darkslategray font-medium text-xl mb-3">
          {{ 'Finalizar Reclamación' | translate }}
        </h1>
        <p class="mb-2 text-sm text-gray-600">
          {{ 'Califique la reclamación de 0 a 5 estrellas (0 = malo, 5 = excelente)' | translate }}
        </p>

        <!-- Finalize Form for rating -->
        <form [formGroup]="finalizeForm" (ngSubmit)="submitFinalize()" class="w-full flex flex-col space-y-3">
          <div class="flex flex-col w-full">
            <label for="finalRating" class="font-semibold mb-1">Rating (0-5)</label>
            <input formControlName="finalRating" id="finalRating" type="number" min="0" max="5"
              class="border border-gray-300 rounded-md p-2" placeholder="e.g. 4" />
          </div>

          <div class="flex justify-end space-x-3 mt-3">
            <button type="button" (click)="closeFinalizeModal()"
              class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
              {{ 'Cancel' | translate }}
            </button>
            <button type="submit"
              class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
              {{ 'Submit' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Ratings Modal -->
  <div *ngIf="showModalRatings" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
      <div class="p-3 flex flex-col items-center">
        <form [formGroup]="fileManager" autocomplete="off" class="w-full flex flex-col space-y-3">
          <h1 class="text-center text-darkslategray font-medium">
            {{ 'Valoration' | translate }}
          </h1>

          <div
            class="flex flex-col lg:flex-row md:flex-row space-y-3 lg:space-y-0 md:space-y-0 lg:space-x-3 md:space-x-3 justify-center">
            <!-- Subscriber Valuation -->
            <div *ngIf="isSubscriber" class="flex flex-col w-full">
              <label for="valuationSubscriber" class="font-semibold">
                {{ 'institutionOsdValuation' | translate }}
              </label>
              <input formControlName="valuationSubscriber" id="valuationSubscriber"
                class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                [placeholder]="this.claim?.valuationsubscriber" />
            </div>

            <!-- Claimant Valuation -->
            <div *ngIf="isClaimant" class="flex flex-col w-full">
              <label for="valuationClaimant" class="font-semibold">
                {{ 'institutionClaimantRating' | translate }}
              </label>
              <input formControlName="valuationClaimant" id="valuationClaimant"
                class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                [placeholder]="this.claim?.valuationclaimant" />
            </div>

            <!-- Free Professional Valuation -->
            <div *ngIf="isFreeProfessional" class="flex flex-col w-full">
              <label for="valuationFreeProfessionals" class="font-semibold">
                {{ 'institutionValuationFreeOsdProfessionals' | translate }}
              </label>
              <input formControlName="valuationFreeProfessionals" id="valuationFreeProfessionals"
                class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                [placeholder]="this.claim?.valuationfreeprofessionals" />
            </div>
          </div>

          <div class="flex justify-center">
            <button (click)="updateValuation()"
              class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
              {{ 'MakeAreview' | translate }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>