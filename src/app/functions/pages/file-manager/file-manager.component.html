<!-- Container to wrap everything, giving some spacing and a consistent layout -->
<div class="">

  <!-- Title Section -->
  <div class="flex flex-col items-start">
    <h2 class="text-xl font-medium py-3">
      <span class="pl-5 pr-3 py-1 bg-yellow-500 rounded-r-full">
        {{ 'reclamacion' | translate }}
      </span>
    </h2>
  </div>

  <!-- Performance Buttons -->
  <div class="flex justify-center py-1">
    <div class="flex flex-col items-center space-y-3 p-3">
      <!-- View Performance Button -->
      <span class="rounded-xl p-2 bg-darkslategray text-line font-bold cursor-pointer"
        (click)="openPerformanceClaimsModal()">
        {{ 'viewPerformance' | translate }}
      </span>
    </div>
  </div>

  <!-- Main Form Section (height reduced to roughly half of its previous size) -->
  <div class="bg-white-lightbone shadow-md rounded-xl p-5 h-1/2 overflow-y-auto">
    <form [formGroup]="fileManager" (ngSubmit)="onSubmit()" autocomplete="off"
      class="grid grid-cols-1 md:grid-cols-2 gap-4">

      <!-- Code Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Code' | translate }}</label>
        <input formControlName="code" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.code" />
      </div>

      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <!-- Justification/Proof File Label (non readOnly; single column) -->
        <label for="downloadButton" class="text-sm text-gray-700 font-medium">
          {{ 'Justification/Proof File of the Claim' | translate }}
        </label>

        <!-- Download Button (non readOnly; single column) -->
        <div class="col-span-1 flex items-center">
          <button id="downloadButton" type="button" class="cursor-pointer px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg shadow-md 
          hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 
          transition ease-in-out duration-150" (click)="downloadSelectedFile('')">
            {{ 'Download' | translate }}
          </button>
        </div>
      </div>

      <!-- Facts Field (readOnly; spans both columns) -->
      <div class="col-span-2 border border-gray-300 rounded-md p-2 h-32">
        <label class="block mb-1 font-medium">{{ 'Facts' | translate }}</label>
        <textarea formControlName="facts" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.facts"></textarea>
      </div>

      <!-- Claimant Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Reclamación' | translate }}</label>
        <input formControlName="claimant" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.namecompanysubscriberclaimed" />
      </div>

      <!-- Status Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Status' | translate }}</label>
        <input formControlName="state" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.status" />
      </div>

      <!-- Amount Claimed Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Amount Claimed' | translate }}</label>
        <input formControlName="amountClaimed" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.claim?.amountclaimed" />
      </div>

      <!-- Valuation Free Professionals Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Valuation Processor' | translate }}</label>
        <input formControlName="valuationFreeProfessionals" type="text" class="w-full bg-white-lightbone"
          [readonly]="true" [placeholder]="this.fileManager.get('valuationFreeProfessionals')?.value" />
      </div>

      <!-- Valuation Claimant Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Valuation Claimant' | translate }}</label>
        <input formControlName="valuationClaimant" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.fileManager.get('valuationClaimant')?.value" />
      </div>

      <!-- Valuation Subscriber Field (readOnly; single column) -->
      <div class="col-span-1 border border-gray-300 rounded-md p-2">
        <label class="block mb-1 font-medium">{{ 'Valuation Subscriber' | translate }}</label>
        <input formControlName="valuationSubscriber" type="text" class="w-full bg-white-lightbone" [readonly]="true"
          [placeholder]="this.fileManager.get('valuationSubscriber')?.value" />
      </div>
    </form>
  </div>

  <!-- Button Section -->
  <div class="flex w-full justify-end p-2 space-x-3">
    <button routerLink="/functions/claims-file"
      class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
      {{ 'regresar' | translate }}
    </button>

    <!-- Instead of directly calling closeClaimFile(), open a "Finalize" modal to gather the rating -->
    <button *ngIf="canCloseClaim" (click)="openFinalizeModal()"
      class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
      {{ 'Finalizar expediente de reclamacion' | translate }}
    </button>
  </div>

  <!-- Add Update Modal -->
  <div *ngIf="showAddUpdateModal" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
      <div class="p-3 flex flex-col items-center">
        <h1 class="text-center text-darkslategray font-medium text-xl mb-3">
          Add Update
        </h1>

        <!-- Modal Form -->
        <form [formGroup]="addUpdateForm" class="w-full flex flex-col space-y-3" (ngSubmit)="submitAddUpdate()">

          <!-- Select Box for Complaint or Appeal -->
          <div *ngIf="!isTrainer" class="flex flex-col w-full mb-4">
            <label for="complaintAppealSelect" class="font-semibold mb-1">{{ 'Type of Update' | translate }}</label>
            <select id="complaintAppealSelect" class="border border-gray-300 rounded-md p-2"
              (change)="onSelectionChange($event)">
              <option value="default" disabled selected>{{ 'Select type of Update' | translate }}</option>
              <option *ngIf="isSubscriber" value="answer_to_appeal">{{ 'Answer_To_Allegation' | translate }}</option>
              <option *ngIf="!isUserProcessor" value="summary">{{ 'Information' | translate }}</option>
              <option *ngIf="isSubscriber" value="solution_suggestion">{{ 'solution_suggestion' | translate }}</option>
              <option *ngIf="!isUserProcessor" value="complaint">{{ 'Complaint' | translate }}</option>
              <option *ngIf="!isUserProcessor" value="appeal">{{ 'Appeal' | translate }}</option>
              <option *ngIf="isUserProcessor" value="verification">{{ 'verification' | translate }}</option>
              <option *ngIf="isUserProcessor" value="ask_for_more_info">{{ 'ask_for_more_info' | translate }}</option>
              <option *ngIf="isUserProcessor" value="solution_complaint">{{ 'solution_complaint' | translate }}</option>
              <option *ngIf="isUserProcessor" value="solution">{{ 'solution' | translate }}</option>
            </select>
          </div>

          <div class="mt-10 grid grid-cols-2 gap-4" *ngIf="selectedOption === 'verification'">
            <!-- Left Column: Download Button -->
            <div class="flex flex-col items-center space-y-1">
              <label for="downloadButton" class="text-medium text-gray-700 mb-3 font-medium">
                {{ (isUserProcessor ? 'Evidence' : 'Adjunct Document of Appeal') | translate }}
              </label>
              <button id="downloadButton" type="button" class="cursor-pointer px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg shadow-md 
                       hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 
                       transition ease-in-out duration-150" (click)="downloadSelectedFile('')">
                {{ 'Download' | translate }}
              </button>
            </div>

            <!-- Right Column: Facts Field -->
            <div class="border border-gray-300 rounded-md p-2 h-32">
              <label class="block mb-1 font-medium">{{ 'Facts' | translate }}</label>
              <textarea formControlName="facts" class="w-full bg-white-lightbone" [readonly]="true"
                [placeholder]="this.claim?.facts"></textarea>
            </div>
          </div>


          <!-- Ask for More Info Checkbox -->
          <div class="flex items-center w-full" *ngIf="isUserProcessor && selectedOption === 'ask_for_more_info'">
            <input formControlName="askForMoreInfo" id="askForMoreInfo" type="checkbox" class="mr-2" />
            <label for="askForMoreInfo" class="font-semibold">Ask for more info</label>
          </div>

          <!-- Document Fields in a Grid (for isUserProcessor) -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 w-full"
            *ngIf="['verification','ask_for_more_info','solution_complaint','solution','solution_suggestion','complaint','appeal','summary','answer_to_appeal','solution_appeal'].includes(selectedOption)">
            <shared-uploadfile [isModified]="false" [uploadFile]="uploadFile" [fileId]="''" [fileName]="''"
              formControlName="document" id="performanceDocument1" [formGroup]="addUpdateForm" label="documento1"
              fieldName="document" (fileUploaded)="handleFileUploaded($event)"></shared-uploadfile>
            <shared-uploadfile [isModified]="false" [uploadFile]="uploadFile" [fileId]="''" [fileName]="''"
              formControlName="document2" id="performanceDocument2" [formGroup]="addUpdateForm" label="documento2"
              fieldName="document2" (fileUploaded)="handleFileUploaded2($event)"></shared-uploadfile>
          </div>

          <!-- Summary / Reason Field -->
          <div
            *ngIf="selectedOption === 'summary' && (!isUserProcessor && !isTrainer) || selectedOption === 'ask_for_more_info' || selectedOption === 'verification'"
            class="flex flex-col w-full">
            <label for="performanceSummary" class="font-semibold mb-1">
              {{ (selectedOption === 'ask_for_more_info' || selectedOption === 'verification' ? 'Explication' :
              'Information') | translate }}
            </label>
            <textarea formControlName="summary" id="performanceSummary"
              class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="addUpdateForm.get('askForMoreInfo')?.value ? 'Enter the reason or missing information' : 'Enter a short description or summary' | translate">
            </textarea>
          </div>

          <!-- Appeal Field ReadOnly for userProcessor -->
          <div *ngIf="!isUserProcessor && !isTrainer && !isClaimant && selectedOption === 'answer_to_appeal'"
            class="flex flex-col w-full">
            <label for="performanceAppeal" class="font-semibold mb-1">{{ 'Appeal' | translate }}</label>
            <textarea formControlName="appeal" id="performanceAppeal" class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="this.claim?.appeal || 'None'" [readonly]="true"></textarea>
          </div>

          <!-- Answer to Appeal Field -->
          <div *ngIf="!isUserProcessor && !isTrainer && !isClaimant && selectedOption === 'answer_to_appeal' "
            class="flex flex-col w-full">
            <label for="performanceAnswerToAppeal" class="font-semibold mb-1">
              {{ 'Answer_To_Allegation' | translate }}
            </label>
            <textarea formControlName="answer_to_appeal" id="performanceAnswerToAppeal"
              class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="'Enter your answer to the allegation' | translate"></textarea>
          </div>

          <!-- Solution Suggestion ReadOnly Field for Processor -->
          <div *ngIf="isUserProcessor && selectedOption === 'solution'" class="flex flex-col w-full">
            <label for="solutionSuggestion" class="font-semibold mb-1">{{ 'solution_suggestion' | translate }}</label>
            <textarea formControlName="solutionSuggestion" id="solutionSuggestion"
              class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="this.claim?.solution_suggestion || 'None'" [readonly]="true"></textarea>
          </div>

          <!-- Solution Field for Processor -->
          <div *ngIf="isUserProcessor && selectedOption === 'solution'" class="flex flex-col w-full">
            <label for="solution" class="font-semibold mb-1">{{ 'solution' | translate }}</label>
            <textarea formControlName="solution" id="solution" class="border border-gray-300 rounded-md p-2 h-32"
              placeholder="{{ 'Enter your solution' | translate }}"></textarea>
          </div>

          <!-- Appeal Readonly Field (conditionally displayed) -->
          <div *ngIf="isTrainer" class="flex flex-col w-full">
            <label for="appeal" class="font-semibold mb-1">{{ 'appeal' | translate }}</label>
            <textarea formControlName="appeal" id="appeal" class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="this.claim?.appeal || 'None'" [readonly]="true"></textarea>
          </div>

          <!-- Solution Appeal Field for Trainer -->
          <div *ngIf="isTrainer" class="flex flex-col w-full">
            <label for="solutionAppeal" class="font-semibold mb-1">{{ 'solution_appeal' | translate }}</label>
            <textarea formControlName="solutionAppeal" id="solutionAppeal"
              class="border border-gray-300 rounded-md p-2 h-32"
              placeholder="{{ 'Enter your solution appeal' | translate }}"></textarea>
          </div>

          <!-- Solution Suggestion Field for non-Trainer -->
          <div *ngIf="!isTrainer && !isClaimant && !isUserProcessor && selectedOption === 'solution_suggestion'"
            class="flex flex-col w-full">
            <label for="solutionSuggestion" class="font-semibold mb-1">{{ 'solution_suggestion' | translate }}</label>
            <textarea formControlName="solutionSuggestion" id="solutionSuggestion"
              class="border border-gray-300 rounded-md p-2 h-32"
              placeholder="{{ 'Enter your solution suggestion' | translate }}"></textarea>
          </div>

          <!-- Complaint Readonly Field (conditionally displayed) -->
          <div *ngIf="isUserProcessor && selectedOption === 'solution_complaint'" class="flex flex-col w-full">
            <label for="complaint" class="font-semibold mb-1">{{ 'complaint' | translate }}</label>
            <textarea formControlName="complaint" id="complaint" class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="this.claim?.complaint || 'None'" [readonly]="true"></textarea>
          </div>

          <!-- Solution Complaint Field (conditionally displayed) -->
          <div *ngIf="isUserProcessor && selectedOption === 'solution_complaint'" class="flex flex-col w-full">
            <label for="solutionComplaint" class="font-semibold mb-1">
              <span>{{ 'Solution Complaint ' | translate }}</span>
            </label>
            <textarea formControlName="solutionComplaint" id="solutionComplaint"
              class="border border-gray-300 rounded-md p-2 h-32"
              [placeholder]="('Enter your complaint solution' | translate)"></textarea>
          </div>

          <!-- Complaint Field (conditionally displayed) -->
          <div *ngIf="(isSubscriber || isClaimant) && selectedOption === 'complaint'" class="flex flex-col w-full">
            <label for="complaint" class="font-semibold mb-1">{{ 'complaint' | translate }}</label>
            <textarea formControlName="complaint" id="complaint" class="border border-gray-300 rounded-md p-2 h-32"
              placeholder="{{ 'Enter your complaint' | translate }}"></textarea>
          </div>

          <!-- Appeal Field (conditionally displayed) -->
          <div *ngIf="(isSubscriber || isClaimant) && selectedOption === 'appeal'" class="flex flex-col w-full">
            <label for="appeal" class="font-semibold mb-1">{{ 'appeal' | translate }}</label>
            <textarea formControlName="appeal" id="appeal" class="border border-gray-300 rounded-md p-2 h-32"
              placeholder="{{ 'Enter your appeal' | translate }}"></textarea>
          </div>

          <!-- Submit / Cancel Buttons -->
          <div class="flex justify-end space-x-3 mt-3">
            <button type="button" (click)="closeAddUpdateModal()"
              class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">
              {{ 'Cancel' | translate }}
            </button>
            <button type="submit"
              class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
              {{ editingPerformance ? ('Update' | translate) : ('Submit' | translate) }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Performance Modal -->
  <div *ngIf="showModalPerformances" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto w-90">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-90 h-90 overflow-y-auto">
      <div class="p-3 flex flex-col items-center space-y-3">
        <table class="table-fixed w-full">
          <thead>
            <tr class="text-darkslategray border-b">
              <th class="w-[0.5rem] py-2 text-xs">{{ 'Code' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Date' | translate }}</th>
              <!-- <th class="w-[0.5rem] py-2">{{ 'Verification' | translate }}</th> -->
              <th class="w-[1rem] py-2">{{ 'Information' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Answer Allegation' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Solution Suggestion' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Solution' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Complaint' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Solution Complaint' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Appeal' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Solution Appeal' | translate }}</th>
              <th class="w-[1rem] py-2">{{ 'Edit' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <!-- Otherwise, show the performances -->
            <tr class="border-t text-center" *ngFor="let performance of displayedItems; let i = index">
              <td class="w-[0.5rem] p-3 text-xs">{{ performance.code }}</td>
              <td class="w-[1rem] p-3">{{ performance.dateperformance | date:'dd-MM-yyyy' }}</td>
              <!-- <td class="w-[1rem] p-2">
              <span *ngIf="!performance.summary" class="text-green-600">&#10003;</span>
              <span *ngIf="performance.summary" class="text-red-600">&#10007;</span>
            </td> -->

              <!-- Information column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.summary && performance.summary.length > 10" type="button"
                  class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.summary, 'Information')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="!performance.summary || performance.summary.length <= 10">
                  {{ performance.summary | translate }}
                </span>
              </td>

              <!-- Answer Allegation column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.answer_to_appeal && performance.answer_to_appeal.length > 10" type="button"
                  class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.answer_to_appeal, 'Answer to Appeal')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="!performance.answer_to_appeal || performance.answer_to_appeal.length <= 10">
                  {{ performance.answer_to_appeal }}
                </span>
              </td>

              <!-- Solution Suggestion column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.solution_suggestion && performance.solution_suggestion.length > 10"
                  type="button" class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.solution_suggestion, 'Solution Suggestion')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="
                  !performance.solution_suggestion ||
                  performance.solution_suggestion.length <= 10
                ">
                  {{ performance.solution_suggestion }}
                </span>
              </td>

              <!-- Solution column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.solution && performance.solution.length > 10" type="button"
                  class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.solution, 'Solution')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="!performance.solution || performance.solution.length <= 10">
                  {{ performance.solution }}
                </span>
              </td>

              <!-- Complaint column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.complaint && performance.complaint.length > 10" type="button"
                  class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.complaint, 'Complaint')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="!performance.complaint || performance.complaint.length <= 10">
                  {{ performance.complaint }}
                </span>
              </td>

              <!-- Solution Complaint column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="
                  performance.solution_complaint &&
                  performance.solution_complaint.length > 10
                " type="button" class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.solution_complaint, 'Solution Complaint')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="
                  !performance.solution_complaint ||
                  performance.solution_complaint.length <= 10
                ">
                  {{ performance.solution_complaint }}
                </span>
              </td>

              <!-- Appeal column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="performance.appeal && performance.appeal.length > 10" type="button"
                  class="text-blue-600 underline" (click)="openTextModal(performance, performance.appeal, 'Appeal')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="!performance.appeal || performance.appeal.length <= 10">
                  {{ performance.appeal }}
                </span>
              </td>

              <!-- Solution Appeal column -->
              <td class="w-[1rem] p-3">
                <button *ngIf="
                  performance.solution_appeal && performance.solution_appeal.length > 10
                " type="button" class="text-blue-600 underline"
                  (click)="openTextModal(performance, performance.solution_appeal, 'Solution Appeal')">
                  {{ 'View' | translate }}
                </button>
                <span *ngIf="
                  !performance.solution_appeal ||
                  performance.solution_appeal.length <= 10
                ">
                  {{ performance.solution_appeal }}
                </span>
              </td>

              <!-- Edit column: only show if performance.userid equals current user's Id -->
              <td class="w-[1rem] p-3" *ngIf="performance.userid === user.Id && canCloseClaim">
                <i class="fa-solid fa-pencil cursor-pointer text-blue-600"
                  (click)="openEditPerformance(performance)"></i>
              </td>
            </tr>
          </tbody>
        </table>

        <mat-paginator [length]="allPerformances.length" [pageSize]="5" (page)="onPageChange($event)"></mat-paginator>

        <div class="relative w-full min-h-[100px]">
          <div class="absolute bottom-0 right-0 flex space-x-3 p-2">
            <button (click)="openAddUpdateModal()"
              class="p-2 rounded-xl bg-indigo-500 text-white font-medium animate__animated animate__fadeInDown">Add
              Update</button>
            <button (click)="closePerformanceModal()"
              class="p-2 rounded-xl bg-line text-darkslategray font-medium animate__animated animate__fadeInDown">Cancel</button>
          </div>
        </div>
      </div>

      <!-- Text Modal (placed as a sibling, not nested) -->
      <div *ngIf="showTextModal" class="fixed inset-0 z-[80] flex items-center justify-center overflow-y-auto w-90">
        <div class="bg-opacity-75 bg-black absolute inset-0" (click)="closeTextModal()"></div>
        <div class="relative z-[80] bg-white shadow-md rounded-xl p-3 w-90">
          <div class="p-3">
            <!-- Show the two documents if they exist -->
            <div class="mb-3 flex space-x-3 items-center justify-start">
              <!-- Document 1 -->
              <div>
                <button *ngIf="modalPerformance?.justifyingdocument" id="downloadButton" type="button" class="mt-2 cursor-pointer px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg shadow-md 
                       hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 
                       transition ease-in-out duration-150"
                  (click)="downloadSelectedFile(modalPerformance.justifyingdocument)">
                  {{ 'Download Document 1' | translate }}
                </button>
                <span *ngIf="!modalPerformance?.justifyingdocument" class="text-gray-500">
                  {{ 'No First Document Provided' | translate }}
                </span>
              </div>

              <!-- Document 2 -->
              <div>
                <button *ngIf="modalPerformance?.justifyingdocument2" id="downloadButton" type="button" class="mt-2 cursor-pointer px-4 py-2 text-sm font-medium bg-indigo-600 text-white rounded-lg shadow-md 
                       hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 
                       transition ease-in-out duration-150"
                  (click)="downloadSelectedFile(modalPerformance.justifyingdocument2)">
                  {{ 'Download Document 2' | translate }}
                </button>
                <span *ngIf="!modalPerformance?.justifyingdocument2" class="text-gray-500">
                  {{ 'No Second Document Provided' | translate }}
                </span>
              </div>
            </div>

            <h2 class="text-lg font-bold mb-3">{{ modalTitle }}</h2>
            <p class="whitespace-pre-wrap">{{ modalContent }}</p>
            <div class="flex justify-end w-full mt-3">
              <button (click)="closeTextModal()" class="p-2 rounded-xl bg-line text-darkslategray font-medium">
                {{ 'Close' | translate }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ratings Modal -->
      <div *ngIf="showModalRatings" class="fixed inset-0 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-opacity-75 bg-black absolute inset-0"></div>
        <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
          <div class="p-3 flex flex-col items-center">
            <form [formGroup]="fileManager" autocomplete="off" class="w-full flex flex-col space-y-3">
              <h1 class="text-center text-darkslategray font-medium">
                {{ 'Valoration' | translate }}
              </h1>

              <div
                class="flex flex-col lg:flex-row md:flex-row space-y-3 lg:space-y-0 md:space-y-0 lg:space-x-3 md:space-x-3 justify-center">
                <!-- Subscriber Valuation -->
                <div *ngIf="isSubscriber" class="flex flex-col w-full">
                  <label for="valuationSubscriber" class="font-semibold">
                    {{ 'institutionOsdValuation' | translate }}
                  </label>
                  <input formControlName="valuationSubscriber" id="valuationSubscriber"
                    class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                    [placeholder]="this.claim?.valuationsubscriber" />
                </div>

                <!-- Claimant Valuation -->
                <div *ngIf="isClaimant" class="flex flex-col w-full">
                  <label for="valuationClaimant" class="font-semibold">
                    {{ 'institutionClaimantRating' | translate }}
                  </label>
                  <input formControlName="valuationClaimant" id="valuationClaimant"
                    class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                    [placeholder]="this.claim?.valuationclaimant" />
                </div>

                <!-- Free Professional Valuation -->
                <div *ngIf="isFreeProfessional" class="flex flex-col w-full">
                  <label for="valuationFreeProfessionals" class="font-semibold">
                    {{ 'institutionValuationFreeOsdProfessionals' | translate }}
                  </label>
                  <input formControlName="valuationFreeProfessionals" id="valuationFreeProfessionals"
                    class="border border-gray-300 rounded-md p-2" type="number" max="5" min="0"
                    [placeholder]="this.claim?.valuationfreeprofessionals" />
                </div>
              </div>

              <div class="flex justify-center">
                <button (click)="updateValuation()"
                  class="p-2 rounded-xl bg-darkslategray text-line font-medium animate__animated animate__fadeInDown">
                  {{ 'MakeAreview' | translate }}
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Finalize Claim (Rating) Modal -->
  <div *ngIf="showFinalizeModal" class="fixed inset-0 z-[9999] flex items-center justify-center">
    <div class="bg-opacity-75 bg-black absolute inset-0"></div>
    <div class="relative z-50 bg-white shadow-md rounded-xl p-3 w-11/12 lg:w-1/2">
      <div class="p-3 flex flex-col items-center">
        <h1 class="text-center text-darkslategray font-medium text-xl mb-3">
          {{ 'Finalizar Reclamación' | translate }}
        </h1>
        <p class="mb-2 text-sm text-gray-600">
          {{ 'Califique la reclamación de 0 a 5 estrellas (0 = malo, 5 = excelente)' | translate }}
        </p>

        <!-- If trainer, show a 2-column grid layout; else single-column -->
        <ng-container *ngIf="isTrainer; else normalLayout">
          <form [formGroup]="finalizeForm" (ngSubmit)="submitFinalize()" class="w-full">
            <!-- Two-column grid: items-stretch ensures columns match in height -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 items-stretch">

              <!-- LEFT COLUMN: read-only fields (if they exist) -->
              <div class="flex flex-col space-y-4">
                <div *ngIf="claim?.valuationfreeprofessionals" class="flex flex-col">
                  <label class="font-semibold mb-1">{{ 'Valuation Processor' | translate }}</label>
                  <input type="text" [value]="claim.valuationfreeprofessionals"
                    class="border border-gray-300 rounded-md p-2 bg-gray-100 text-gray-700" readonly />
                </div>

                <div *ngIf="claim?.improvementsavings" class="flex flex-col">
                  <label class="font-semibold mb-1">{{ 'Improvement Savings' | translate }} {{ 'Processor' | translate
                    }}</label>
                  <input type="text" [value]="claim.improvementsavings"
                    class="border border-gray-300 rounded-md p-2 bg-gray-100 text-gray-700" readonly />
                </div>

                <div *ngIf="claim?.amountpaid" class="flex flex-col">
                  <label class="font-semibold mb-1">{{ 'Amount Paid' | translate }} {{ 'Processor' | translate
                    }}</label>
                  <input type="text" [value]="claim.amountpaid"
                    class="border border-gray-300 rounded-md p-2 bg-gray-100 text-gray-700" readonly />
                </div>
              </div>

              <!-- RIGHT COLUMN: normal editable fields -->
              <div class="flex flex-col space-y-4">
                <div class="flex flex-col">
                  <label for="finalRating" class="font-semibold mb-1">{{ 'Rating (0-5)' | translate }}</label>
                  <input formControlName="finalRating" id="finalRating" type="number" min="0" max="5"
                    class="border border-gray-300 rounded-md p-2" placeholder="e.g. 4" />
                </div>

                <div *ngIf="isTrainer || isUserProcessor" class="flex flex-col">
                  <label for="savingsImprovement" class="font-semibold mb-1">
                    {{ 'Savings/Improvement - Continuous' | translate }}
                  </label>
                  <input formControlName="savingsImprovement" id="savingsImprovement" type="text"
                    class="border border-gray-300 rounded-md p-2" placeholder="{{ 'e.g. 12000' | translate }}" />
                </div>

                <div *ngIf="isTrainer || isUserProcessor" class="flex flex-col">
                  <label for="claimantPayment" class="font-semibold mb-1">
                    {{ 'Claimant Payment' | translate }}
                  </label>
                  <input formControlName="claimantPayment" id="claimantPayment" type="text"
                    class="border border-gray-300 rounded-md p-2" placeholder="{{ 'e.g. 3000' | translate }}" />
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-end space-x-3 mt-4" *ngIf="canCloseClaim">
              <button type="button" (click)="closeFinalizeModal()"
                class="p-2 rounded-xl bg-line text-darkslategray font-medium">
                {{ 'Cancel' | translate }}
              </button>
              <button type="submit" class="p-2 rounded-xl bg-darkslategray text-line font-medium">
                {{ editingPerformance ? ('Update' | translate) : ('Submit' | translate) }}
              </button>
            </div>
          </form>
        </ng-container>

        <!-- ELSE: normal layout if NOT trainer -->
        <ng-template #normalLayout>
          <form [formGroup]="finalizeForm" (ngSubmit)="submitFinalize()" class="w-full flex flex-col space-y-3">
            <div class="flex flex-col w-full">
              <label for="finalRating" class="font-semibold mb-1">Rating (0-5)</label>
              <input formControlName="finalRating" id="finalRating" type="number" min="0" max="5"
                class="border border-gray-300 rounded-md p-2" placeholder="e.g. 4" />
            </div>

            <div *ngIf="isTrainer || isUserProcessor" class="flex flex-col w-full">
              <label for="savingsImprovement" class="font-semibold mb-1">
                {{ 'Savings/Improvement - Continuous' | translate }}
              </label>
              <input formControlName="savingsImprovement" id="savingsImprovement" type="text"
                class="border border-gray-300 rounded-md p-2" placeholder="{{ 'e.g. 12000' | translate }}" />
            </div>

            <div *ngIf="isTrainer || isUserProcessor" class="flex flex-col w-full">
              <label for="claimantPayment" class="font-semibold mb-1">
                {{ 'Claimant Payment' | translate }}
              </label>
              <input formControlName="claimantPayment" id="claimantPayment" type="text"
                class="border border-gray-300 rounded-md p-2" placeholder="{{ 'e.g. 3000' | translate }}" />
            </div>

            <div class="flex justify-end space-x-3 mt-3" *ngIf="canCloseClaim">
              <button type="button" (click)="closeFinalizeModal()"
                class="p-2 rounded-xl bg-line text-darkslategray font-medium">
                {{ 'Cancel' | translate }}
              </button>
              <button type="submit" class="p-2 rounded-xl bg-darkslategray text-line font-medium">
                {{ editingPerformance ? ('Update' | translate) : ('Submit' | translate) }}
              </button>
            </div>
          </form>
        </ng-template>
      </div>
    </div>
  </div>